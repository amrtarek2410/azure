version: 0.2
phases:
  install:
    commands:
      # Install system dependencies
      - apt-get update -y
      - apt-get install -y postgresql-client  # Ubuntu package name for psql
      - apt-get install -y docker.io
      
      # Install Python requirements
      - pip3 install psycopg2-binary coverage
      
      # Install SonarScanner
      - wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
      - unzip sonar-scanner-*.zip -d /opt
      - export PATH="/opt/sonar-scanner-5.0.1.3006-linux/bin:$PATH"

  pre_build:
    commands:
      # Start PostgreSQL container with explicit password
      - docker run -d --name test-db -e POSTGRES_PASSWORD=postgres -p 5432:5432 postgres:13
      
      # Wait for PostgreSQL to become available (with retries)
      - timeout 30 bash -c 'until psql -h localhost -U postgres -c "SELECT 1"; do sleep 2; done'
      
      # Create test database
      - psql -h localhost -U postgres -c "CREATE DATABASE testdb;"

      # Run tests with coverage
      - coverage run -m unittest discover -s . -p "test_*.py"

  build:
    commands:
      - coverage xml
      - sonar-scanner
        -Dsonar.projectKey=database-handler
        -Dsonar.host.url=http://18.224.55.83:9000
        -Dsonar.login=sqp_7c522efefa152b51581dbc078c8427f88ee2654f
        -Dsonar.sources=.
        -Dsonar.python.coverage.reportPaths=coverage.xml

  post_build:
    commands:
      - docker stop test-db
      - docker rm test-db
